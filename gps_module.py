#!/usr/bin/python3

import paho.mqtt.client as mqtt
import time
import threading
import datetime
import json
from uuid import getnode as get_mac

def main():
    print("Start main!")
    app = App()


class App(threading.Thread):
    #def __init__(self, q, loop_time = 1.0/60):
    def __init__(self):
        super(App, self).__init__()
        self.TRACE_JSON = '/opt/telecard/trace.json'

        self._message_id = 0
        #self._tz = pytz.timezone('Europe/Kiev')
        self._dst = time.daylight and time.localtime().tm_isdst > 0
        self._utc_offset = - (time.altzone if self._dst else time.timezone)
        self._gps_idx = 0
        self.latitude = 0.0
        self.longitude = 0.0
        self._mac = hex(get_mac())[2:14]
        self._mac = self._mac.upper()
        print("my MAC is: {}".format(self._mac))


        self._gps_array = [
            [50.400812, 30.651314],
            [50.400812, 30.651314],
            [50.400835, 30.651481],
            [50.400858, 30.651648],
            [50.400881, 30.651815],
            [50.400905, 30.651983],
            [50.400928, 30.652150],
            [50.400951, 30.652317],
            [50.400989, 30.652507],
            [50.401026, 30.652696],
            [50.401064, 30.652886],
            [50.401102, 30.653075],
            [50.401139, 30.653264],
            [50.401177, 30.653454],
            [50.401127, 30.653520],
            [50.401077, 30.653586],
            [50.401027, 30.653652],
            [50.400976, 30.653719],
            [50.400926, 30.653785],
            [50.400876, 30.653851],
            [50.400747, 30.653708],
            [50.400618, 30.653565],
            [50.400489, 30.653422],
            [50.400361, 30.653279],
            [50.400232, 30.653136],
            [50.400103, 30.652993],
            [50.400103, 30.652993],
            [50.400103, 30.652993],
            [50.400183, 30.652873],
            [50.400263, 30.652753],
            [50.400343, 30.652634],
            [50.400422, 30.652514],
            [50.400502, 30.652394],
            [50.400582, 30.652274],
            [50.400666, 30.652235],
            [50.400751, 30.652195],
            [50.400835, 30.652156],
            [50.400919, 30.652117],
            [50.401004, 30.652077],
            [50.401088, 30.652038],
            [50.401179, 30.652011],
            [50.401270, 30.651984],
            [50.401362, 30.651958],
            [50.401453, 30.651931],
            [50.401544, 30.651904],
            [50.401635, 30.651877],
            [50.401740, 30.651840],
            [50.401845, 30.651804],
            [50.401950, 30.651767],
            [50.402056, 30.651730],
            [50.402161, 30.651694],
            [50.402266, 30.651657],
            [50.402266, 30.651657],
            [50.402266, 30.651657],
            [50.402360, 30.651622],
            [50.402455, 30.651587],
            [50.402549, 30.651553],
            [50.402643, 30.651518],
            [50.402738, 30.651483],
            [50.402832, 30.651448],
            [50.402923, 30.651409],
            [50.403014, 30.651369],
            [50.403105, 30.651330],
            [50.403197, 30.651291],
            [50.403288, 30.651251],
            [50.403379, 30.651212],
            [50.403512, 30.651183],
            [50.403646, 30.651155],
            [50.403779, 30.651126],
            [50.403912, 30.651097],
            [50.404046, 30.651069],
            [50.404179, 30.651040],
            [50.404301, 30.650983],
            [50.404423, 30.650926],
            [50.404545, 30.650869],
            [50.404667, 30.650811],
            [50.404789, 30.650754],
            [50.404911, 30.650697],
            [50.405004, 30.650641],
            [50.405098, 30.650586],
            [50.405192, 30.650531],
            [50.405285, 30.650475],
            [50.405379, 30.650419],
            [50.405472, 30.650364],
            [50.405559, 30.650314],
            [50.405645, 30.650264],
            [50.405732, 30.650214],
            [50.405818, 30.650164],
            [50.405904, 30.650114],
            [50.405991, 30.650064],
            [50.406053, 30.650046],
            [50.406115, 30.650027],
            [50.406177, 30.650009],
            [50.406240, 30.649991],
            [50.406302, 30.649972],
            [50.406364, 30.649954],
            [50.406364, 30.649954],
            [50.406364, 30.649954],
            [50.406464, 30.649874],
            [50.406563, 30.649794],
            [50.406663, 30.649714],
            [50.406763, 30.649633],
            [50.406862, 30.649553],
            [50.406962, 30.649473],
            [50.407038, 30.649427],
            [50.407115, 30.649380],
            [50.407191, 30.649334],
            [50.407267, 30.649287],
            [50.407344, 30.649241],
            [50.407420, 30.649194],
            [50.407511, 30.649139],
            [50.407602, 30.649083],
            [50.407694, 30.649028],
            [50.407785, 30.648973],
            [50.407876, 30.648917],
            [50.407967, 30.648862],
            [50.408047, 30.648810],
            [50.408127, 30.648758],
            [50.408206, 30.648707],
            [50.408286, 30.648655],
            [50.408366, 30.648603],
            [50.408446, 30.648551],
            [50.408538, 30.648497],
            [50.408631, 30.648444],
            [50.408723, 30.648390],
            [50.408815, 30.648336],
            [50.408908, 30.648283],
            [50.409000, 30.648229],
            [50.409098, 30.648168],
            [50.409196, 30.648107],
            [50.409294, 30.648046],
            [50.409392, 30.647986],
            [50.409490, 30.647925],
            [50.409588, 30.647864],
            [50.409667, 30.647816],
            [50.409745, 30.647767],
            [50.409824, 30.647719],
            [50.409903, 30.647671],
            [50.409981, 30.647622],
            [50.410060, 30.647574],
            [50.410127, 30.647555],
            [50.410194, 30.647536],
            [50.410260, 30.647517],
            [50.410327, 30.647499],
            [50.410394, 30.647480],
            [50.410461, 30.647461],
            [50.410461, 30.647461],
            [50.410461, 30.647461],
            [50.410589, 30.647371],
            [50.410717, 30.647281],
            [50.410845, 30.647191],
            [50.410973, 30.647100],
            [50.411101, 30.647010],
            [50.411229, 30.646920],
            [50.411354, 30.646843],
            [50.411480, 30.646766],
            [50.411605, 30.646690],
            [50.411730, 30.646613],
            [50.411856, 30.646536],
            [50.411981, 30.646459],
            [50.412117, 30.646384],
            [50.412252, 30.646309],
            [50.412388, 30.646234],
            [50.412524, 30.646158],
            [50.412659, 30.646083],
            [50.412795, 30.646008],
            [50.412851, 30.646026],
            [50.412907, 30.646044],
            [50.412963, 30.646062],
            [50.413018, 30.646079],
            [50.413074, 30.646097],
            [50.413130, 30.646115],
            [50.413170, 30.646097],
            [50.413210, 30.646079],
            [50.413250, 30.646062],
            [50.413289, 30.646044],
            [50.413329, 30.646026],
            [50.413369, 30.646008],
            [50.413396, 30.645926],
            [50.413424, 30.645844],
            [50.413451, 30.645761],
            [50.413478, 30.645679],
            [50.413506, 30.645597],
            [50.413533, 30.645515],
            [50.413581, 30.645484],
            [50.413629, 30.645454],
            [50.413677, 30.645423],
            [50.413724, 30.645393],
            [50.413772, 30.645363],
            [50.413820, 30.645332],
            [50.413932, 30.645260],
            [50.414043, 30.645189],
            [50.414155, 30.645117],
            [50.414267, 30.645046],
            [50.414378, 30.644975],
            [50.414490, 30.644903],
            [50.414490, 30.644903],
            [50.414490, 30.644903],
            [50.414482, 30.644910],
            [50.414474, 30.644917],
            [50.414466, 30.644925],
            [50.414458, 30.644932],
            [50.414450, 30.644939],
            [50.414442, 30.644946],
            [50.414567, 30.644866],
            [50.414693, 30.644785],
            [50.414818, 30.644704],
            [50.414943, 30.644624],
            [50.415069, 30.644543],
            [50.415194, 30.644463],
            [50.415306, 30.644399],
            [50.415417, 30.644334],
            [50.415529, 30.644270],
            [50.415641, 30.644206],
            [50.415752, 30.644141],
            [50.415864, 30.644077],
            [50.415956, 30.644054],
            [50.416048, 30.644032],
            [50.416140, 30.644009],
            [50.416232, 30.643987],
            [50.416324, 30.643964],
            [50.416416, 30.643942],
            [50.416416, 30.643942],
            [50.416416, 30.643942],
            [50.416496, 30.643868],
            [50.416576, 30.643794],
            [50.416657, 30.643719],
            [50.416737, 30.643645],
            [50.416817, 30.643571],
            [50.416897, 30.643497],
            [50.416993, 30.643438],
            [50.417088, 30.643379],
            [50.417184, 30.643320],
            [50.417280, 30.643261],
            [50.417375, 30.643202],
            [50.417471, 30.643143],
            [50.417602, 30.643064],
            [50.417733, 30.642986],
            [50.417864, 30.642907],
            [50.417995, 30.642828],
            [50.418126, 30.642750],
            [50.418257, 30.642671],
            [50.418365, 30.642605],
            [50.418473, 30.642539],
            [50.418582, 30.642473],
            [50.418690, 30.642406],
            [50.418798, 30.642340],
            [50.418906, 30.642274],
            [50.419004, 30.642217],
            [50.419102, 30.642160],
            [50.419200, 30.642103],
            [50.419298, 30.642045],
            [50.419396, 30.641988],
            [50.419494, 30.641931],
            [50.419563, 30.641919],
            [50.419632, 30.641908],
            [50.419702, 30.641896],
            [50.419771, 30.641884],
            [50.419840, 30.641873],
            [50.419909, 30.641861],
            [50.419909, 30.641861],
            [50.419909, 30.641861],
            [50.419995, 30.641774],
            [50.420081, 30.641688],
            [50.420166, 30.641601],
            [50.420252, 30.641514],
            [50.420338, 30.641428],
            [50.420424, 30.641341],
            [50.420525, 30.641228],
            [50.420627, 30.641116],
            [50.420728, 30.641003],
            [50.420829, 30.640890],
            [50.420931, 30.640778],
            [50.421032, 30.640665],
            [50.421145, 30.640599],
            [50.421258, 30.640533],
            [50.421370, 30.640466],
            [50.421483, 30.640400],
            [50.421596, 30.640334],
            [50.421709, 30.640268],
            [50.421823, 30.640196],
            [50.421937, 30.640125],
            [50.422051, 30.640054],
            [50.422165, 30.639982],
            [50.422279, 30.639910],
            [50.422393, 30.639839],
            [50.422522, 30.639757],
            [50.422650, 30.639674],
            [50.422779, 30.639592],
            [50.422908, 30.639510],
            [50.423036, 30.639427],
            [50.423165, 30.639345],
            [50.423302, 30.639257],
            [50.423438, 30.639170],
            [50.423575, 30.639083],
            [50.423712, 30.638995],
            [50.423848, 30.638907],
            [50.423985, 30.638820],
            [50.424092, 30.638807],
            [50.424200, 30.638795],
            [50.424307, 30.638782],
            [50.424414, 30.638770],
            [50.424522, 30.638758],
            [50.424629, 30.638745],
            [50.424738, 30.638831],
            [50.424847, 30.638917],
            [50.424957, 30.639003],
            [50.425066, 30.639088],
            [50.425175, 30.639174],
            [50.425284, 30.639260],
            [50.425364, 30.639340],
            [50.425444, 30.639421],
            [50.425523, 30.639501],
            [50.425603, 30.639581],
            [50.425683, 30.639662],
            [50.425763, 30.639742],
            [50.425708, 30.639928],
            [50.425653, 30.640114],
            [50.425599, 30.640300],
            [50.425544, 30.640486],
            [50.425489, 30.640672],
            [50.425434, 30.640858],
            [50.425375, 30.641062],
            [50.425316, 30.641266],
            [50.425257, 30.641469],
            [50.425197, 30.641673],
            [50.425138, 30.641877],
            [50.425079, 30.642081],
            [50.425021, 30.642264],
            [50.424963, 30.642446],
            [50.424904, 30.642629],
            [50.424846, 30.642811],
            [50.424788, 30.642993],
            [50.424730, 30.643176],
            [50.424668, 30.643329],
            [50.424606, 30.643481],
            [50.424544, 30.643634],
            [50.424483, 30.643787],
            [50.424421, 30.643939],
            [50.424359, 30.644092],
            [50.424359, 30.644092],
            [50.424359, 30.644092],
            [50.424312, 30.644292],
            [50.424264, 30.644491],
            [50.424216, 30.644690],
            [50.424169, 30.644890],
            [50.424121, 30.645089],
            [50.424074, 30.645289],
            [50.424022, 30.645452],
            [50.423969, 30.645615],
            [50.423917, 30.645778],
            [50.423865, 30.645940],
            [50.423812, 30.646103],
            [50.423760, 30.646266],
            [50.423712, 30.646228],
            [50.423664, 30.646191],
            [50.423617, 30.646153],
            [50.423569, 30.646115],
            [50.423521, 30.646078],
            [50.423473, 30.646040],
            [50.423401, 30.645715],
            [50.423329, 30.645389],
            [50.423258, 30.645064],
            [50.423186, 30.644739],
            [50.423114, 30.644413],
            [50.423042, 30.644088],
            [50.423042, 30.644088],
            [50.423042, 30.644088],
            [50.423042, 30.644088],
            [50.423042, 30.644088],
            [50.423046, 30.643970],
            [50.423051, 30.643851],
            [50.423056, 30.643732],
            [50.423060, 30.643614],
            [50.423064, 30.643496],
            [50.423069, 30.643377],
            [50.423003, 30.643285],
            [50.422937, 30.643192],
            [50.422871, 30.643099],
            [50.422805, 30.643007],
            [50.422739, 30.642914],
            [50.422673, 30.642822],
            [50.422615, 30.642581],
            [50.422557, 30.642339],
            [50.422499, 30.642097],
            [50.422440, 30.641856],
            [50.422382, 30.641615],
            [50.422324, 30.641373],
            [50.422324, 30.641337],
            [50.422324, 30.641302],
            [50.422324, 30.641266],
            [50.422324, 30.641230],
            [50.422324, 30.641195],
            [50.422324, 30.641159],
            [50.422272, 30.640973],
            [50.422219, 30.640787],
            [50.422167, 30.640601],
            [50.422115, 30.640415],
            [50.422062, 30.640229],
            [50.422010, 30.640043],
            [50.421943, 30.640071],
            [50.421876, 30.640100],
            [50.421808, 30.640128],
            [50.421741, 30.640157],
            [50.421674, 30.640186],
            [50.421607, 30.640214],
            [50.421517, 30.640268],
            [50.421427, 30.640321],
            [50.421337, 30.640375],
            [50.421247, 30.640429],
            [50.421157, 30.640482],
            [50.421067, 30.640536],
            [50.420941, 30.640604],
            [50.420814, 30.640672],
            [50.420687, 30.640740],
            [50.420561, 30.640808],
            [50.420434, 30.640876],
            [50.420308, 30.640944],
            [50.420236, 30.640986],
            [50.420165, 30.641029],
            [50.420093, 30.641071],
            [50.420021, 30.641113],
            [50.419950, 30.641156],
            [50.419878, 30.641198],
            [50.419878, 30.641198],
            [50.419878, 30.641198],
            [50.419746, 30.641281],
            [50.419613, 30.641364],
            [50.419481, 30.641447],
            [50.419349, 30.641529],
            [50.419216, 30.641612],
            [50.419084, 30.641695],
            [50.418955, 30.641779],
            [50.418827, 30.641863],
            [50.418698, 30.641947],
            [50.418569, 30.642031],
            [50.418441, 30.642115],
            [50.418312, 30.642199],
            [50.418232, 30.642242],
            [50.418152, 30.642285],
            [50.418073, 30.642328],
            [50.417993, 30.642371],
            [50.417913, 30.642414],
            [50.417833, 30.642457],
            [50.417770, 30.642460],
            [50.417708, 30.642464],
            [50.417645, 30.642468],
            [50.417582, 30.642471],
            [50.417520, 30.642474],
            [50.417457, 30.642478],
            [50.417370, 30.642521],
            [50.417284, 30.642564],
            [50.417198, 30.642607],
            [50.417111, 30.642650],
            [50.417025, 30.642693],
            [50.416938, 30.642736],
            [50.416885, 30.642798],
            [50.416832, 30.642861],
            [50.416780, 30.642924],
            [50.416727, 30.642986],
            [50.416674, 30.643048],
            [50.416621, 30.643111],
            [50.416492, 30.643143],
            [50.416363, 30.643175],
            [50.416235, 30.643206],
            [50.416106, 30.643238],
            [50.415977, 30.643270],
            [50.415848, 30.643302],
            [50.415848, 30.643302],
            [50.415848, 30.643302],
            [50.415760, 30.643360],
            [50.415671, 30.643417],
            [50.415582, 30.643475],
            [50.415494, 30.643533],
            [50.415405, 30.643590],
            [50.415317, 30.643648],
            [50.415185, 30.643721],
            [50.415053, 30.643795],
            [50.414921, 30.643868],
            [50.414788, 30.643941],
            [50.414656, 30.644015],
            [50.414524, 30.644088],
            [50.414406, 30.644161],
            [50.414287, 30.644234],
            [50.414169, 30.644308],
            [50.414050, 30.644381],
            [50.413931, 30.644454],
            [50.413813, 30.644527],
            [50.413731, 30.644565],
            [50.413649, 30.644602],
            [50.413567, 30.644640],
            [50.413485, 30.644678],
            [50.413403, 30.644715],
            [50.413321, 30.644753],
            [50.413249, 30.644744],
            [50.413177, 30.644735],
            [50.413106, 30.644726],
            [50.413034, 30.644717],
            [50.412962, 30.644708],
            [50.412890, 30.644699],
            [50.412841, 30.644794],
            [50.412792, 30.644889],
            [50.412743, 30.644984],
            [50.412694, 30.645078],
            [50.412645, 30.645173],
            [50.412596, 30.645268],
            [50.412596, 30.645268],
            [50.412596, 30.645268],
            [50.412596, 30.645268],
            [50.412499, 30.645334],
            [50.412401, 30.645399],
            [50.412304, 30.645465],
            [50.412207, 30.645531],
            [50.412109, 30.645596],
            [50.412012, 30.645662],
            [50.411914, 30.645725],
            [50.411817, 30.645788],
            [50.411720, 30.645851],
            [50.411622, 30.645914],
            [50.411524, 30.645977],
            [50.411427, 30.646040],
            [50.411250, 30.646148],
            [50.411073, 30.646257],
            [50.410896, 30.646365],
            [50.410718, 30.646473],
            [50.410541, 30.646582],
            [50.410364, 30.646690],
            [50.410364, 30.646690],
            [50.410364, 30.646690],
            [50.410228, 30.646769],
            [50.410092, 30.646849],
            [50.409956, 30.646929],
            [50.409819, 30.647008],
            [50.409683, 30.647087],
            [50.409547, 30.647167],
            [50.409407, 30.647253],
            [50.409267, 30.647339],
            [50.409126, 30.647424],
            [50.408986, 30.647510],
            [50.408846, 30.647596],
            [50.408706, 30.647682],
            [50.408576, 30.647757],
            [50.408446, 30.647832],
            [50.408316, 30.647907],
            [50.408186, 30.647982],
            [50.408056, 30.648057],
            [50.407926, 30.648132],
            [50.407801, 30.648205],
            [50.407675, 30.648279],
            [50.407550, 30.648352],
            [50.407425, 30.648425],
            [50.407299, 30.648499],
            [50.407174, 30.648572],
            [50.407024, 30.648661],
            [50.406874, 30.648749],
            [50.406724, 30.648838],
            [50.406575, 30.648927],
            [50.406425, 30.649015],
            [50.406275, 30.649104],
            [50.406275, 30.649104],
            [50.406275, 30.649104],
            [50.406187, 30.649164],
            [50.406098, 30.649224],
            [50.406010, 30.649284],
            [50.405922, 30.649343],
            [50.405833, 30.649403],
            [50.405745, 30.649463],
            [50.405622, 30.649535],
            [50.405499, 30.649606],
            [50.405376, 30.649678],
            [50.405253, 30.649749],
            [50.405130, 30.649821],
            [50.405007, 30.649892],
            [50.404879, 30.649973],
            [50.404752, 30.650053],
            [50.404624, 30.650134],
            [50.404496, 30.650214],
            [50.404369, 30.650295],
            [50.404241, 30.650375],
            [50.404145, 30.650455],
            [50.404049, 30.650536],
            [50.403954, 30.650616],
            [50.403858, 30.650696],
            [50.403762, 30.650777],
            [50.403666, 30.650857],
            [50.403574, 30.650903],
            [50.403483, 30.650949],
            [50.403391, 30.650994],
            [50.403299, 30.651040],
            [50.403208, 30.651086],
            [50.403116, 30.651132],
            [50.403116, 30.651132],
            [50.403116, 30.651132],
            [50.402944, 30.651192],
            [50.402773, 30.651251],
            [50.402602, 30.651311],
            [50.402430, 30.651371],
            [50.402259, 30.651430],
            [50.402087, 30.651490],
            [50.401921, 30.651567],
            [50.401754, 30.651644],
            [50.401588, 30.651721],
            [50.401421, 30.651798],
            [50.401255, 30.651875],
            [50.401088, 30.651952],
            [50.400942, 30.652006],
            [50.400796, 30.652059],
            [50.400650, 30.652113],
            [50.400505, 30.652167],
            [50.400359, 30.652220],
            [50.400213, 30.652274],
            [50.400159, 30.652163],
            [50.400106, 30.652052],
            [50.400052, 30.651941],
            [50.399998, 30.651830],
            [50.399945, 30.651719],
            [50.399891, 30.651608],
            [50.399963, 30.651463],
            [50.400035, 30.651318],
            [50.400106, 30.651173],
            [50.400178, 30.651029],
            [50.400250, 30.650884],
            [50.400322, 30.650739],
            [50.400404, 30.650835],
            [50.400485, 30.650931],
            [50.400567, 30.651027],
            [50.400649, 30.651122],
            [50.400730, 30.651218],
            [50.400812, 30.651314],
            [50.400812, 30.651314],
            [50.400812, 30.651314]
        ]

        self.start()

    def to_driver(self, payload):
        #print("to_driver")
        self._message_id += 1
        payload['timestamp'] = int((time.time())) + self._utc_offset
        payload['mac'] = self._mac
        print(payload)
        resultJSON = json.dumps(payload, ensure_ascii=False).encode('utf8')
        self.client.publish("t_driver", resultJSON)
        return

    def to_bkts(self, payload):
        # print("to_bkts")
        self._message_id += 1
        payload['timestamp'] = int((time.time())) + self._utc_offset
        # print(payload)
        resultJSON = json.dumps(payload, ensure_ascii=False).encode('utf8')
        self.client.publish("t_bkts", resultJSON)
        return

    def emmulate_gps(self):
        # print("emmulate_gps")

        if self._gps_idx >= self._gps_array.__len__():
            self._gps_idx = 0

        self.latitude,self.longitude  = self._gps_array[self._gps_idx]
        self._gps_idx += 1

        payload = dict(
            type=310,
            latitude=self.latitude,
            longitude=self.longitude,
        )
        self.to_driver(payload)

        payload = dict(
            type=110,
            latitude=self.latitude,
            longitude=self.longitude,
        )
        self.to_bkts(payload)


    def on_connect(self, client, payload, flag, rc):
        print("connected OK" if rc == 0 else "Bad connnection = {}".format(rc))

    def on_message(self, client, userdata, message):
        print("on_message: {}".format(message.payload.decode("utf-8")))

    def local_exec(self):
        self.emmulate_gps()

    def run(self):
        broker = "localhost"
        self.client = mqtt.Client("GPS")  # create new instance
        self.client.on_connect = self.on_connect  # attach function to callback
        self.client.on_message = self.on_message  # attach function to callback

        print("Connection to broker ", broker)
        try:
            self.client.connect(broker)

        except Exception as e:
            print("Can't connect: ", e)
            exit(1)
        else:
            i = 0
            loop_flag = 1
            while loop_flag == 1:
                time.sleep(1)
                i += 1
                if i > 0:
                    i = 0
                    self.local_exec()

            self.client.loop_stop()
            self.client.disconnect()

    # *****************************************************************************************



if __name__ == "__main__": main()
